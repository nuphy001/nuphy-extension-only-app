# 购物车验证 Function 测试指南

## 📦 部署步骤

### 1. 构建并部署到 Shopify

```bash
# 在项目根目录运行
npm run deploy
```

这个命令会：
- 编译 Function 为 WebAssembly
- 上传到 Shopify
- 创建一个新版本

### 2. 在 Shopify Admin 中激活 Function

1. 登录你的 Shopify Admin 后台
2. 进入 **Settings（设置）** > **Checkout（结账）**
3. 在 **Cart and checkout validations（购物车和结账验证）** 部分
4. 找到你的 Function: `nuphy-cart-checkout-validation`
5. 点击 **Activate（激活）**

### 3. 在测试店铺中验证

## 🧪 测试场景

由于代码中添加了调试信息，每个错误信息都会在购物车页面显示，这样你就能看到：
- Function 是否被执行
- 获取到了哪些产品信息
- 触发了哪些验证规则

### 测试场景 1: 验证 Function 是否执行

**操作**：在购物车中添加任意产品

**预期结果**：
- 在购物车页面会看到调试信息：
  ```
  [调试] 购物车中共有 X 个商品行
  [调试] 商品1: gid://shopify/Product/XXXX, 数量: X
  [调试] A产品数量: X, B产品存在: true/false, 其他产品: true/false
  ```

✅ **如果看到这些调试信息，说明 Function 正在执行**

### 测试场景 2: 测试规则 1 - A产品数量限制

**操作**：
1. 添加产品 A (ID: `8950899409153`) 到购物车
2. 将数量改为 2 或更多
3. 添加一个其他产品

**预期结果**：
- 看到错误信息：`此产品每次只能购买1个,请调整数量`
- 加上调试信息显示数量统计

### 测试场景 3: 测试规则 2 - A和B产品互斥

**操作**：
1. 添加产品 A (ID: `8950899409153`)，数量 1
2. 添加产品 B (ID: `8950899507457`)，数量 1

**预期结果**：
- 看到错误信息：`这两个产品不能同时购买,请移除其中一个`
- 调试信息显示 `B产品存在: true`

### 测试场景 4: 测试规则 3 - A产品不能单独购买

**操作**：
1. 清空购物车
2. 只添加产品 A (ID: `8950899409153`)，数量 1

**预期结果**：
- 看到错误信息：`此产品不能单独购买,请添加其他产品到购物车`
- 调试信息显示 `其他产品: false`

### 测试场景 5: 正常购买 - 不触发错误

**操作**：
1. 添加产品 A (ID: `8950899409153`)，数量 1
2. 添加其他产品（非产品B），数量任意

**预期结果**：
- 只看到调试信息，没有业务错误
- 可以正常进入结账页面

## 🔍 查看日志的其他方法

### 方法 1: 使用 Shopify CLI 开发模式

```bash
# 在项目根目录运行
npm run dev
```

这会启动开发模式，你可以：
- 实时修改代码并自动重新部署
- 在终端看到 Function 的执行日志
- 使用临时的开发环境测试

### 方法 2: 查看 Shopify Admin 日志

1. 进入 Shopify Admin
2. 访问 **Settings** > **Checkout**
3. 找到你的 Function
4. 点击查看详情，可能会有执行日志

### 方法 3: 使用浏览器开发者工具

1. 打开购物车页面
2. 按 F12 打开开发者工具
3. 查看 **Network（网络）** 标签
4. 筛选 GraphQL 请求，查找 `cart` 相关的请求
5. 检查响应中的 `userErrors` 或 `validationErrors` 字段

## 📝 生产环境注意事项

**部署到生产环境前，务必删除所有调试代码！**

在 `cart_validations_generate_run.js` 中删除：
- 第 22-25 行: `[调试] 购物车中共有 X 个商品行`
- 第 46-49 行: `[调试] 商品X: ...`
- 第 61-64 行: `[调试] A产品数量: ...`

只保留真正的业务验证错误消息。

## 🛠️ 常见问题

### Q: 为什么看不到任何错误信息？

**可能原因**：
1. Function 未激活 - 检查 Shopify Admin 设置
2. Function 未部署 - 运行 `npm run deploy`
3. 使用了错误的产品ID - 检查代码中的 `PRODUCT_A_ID` 和 `PRODUCT_B_ID`

### Q: 如何获取产品ID？

1. 在 Shopify Admin 中打开产品页面
2. URL 中会显示产品ID，例如：
   ```
   https://admin.shopify.com/store/YOUR_STORE/products/8950899409153
   ```
3. 完整的 GraphQL ID 格式：`gid://shopify/Product/8950899409153`

### Q: 调试信息太多了怎么办？

如果只想看到特定的调试信息，可以：
1. 注释掉不需要的调试代码
2. 或者修改条件，只在特定情况下输出调试信息

例如：
```javascript
// 只在有产品A时显示调试信息
if (productAQuantity > 0) {
  errors.push({
    message: `[调试] A产品数量: ${productAQuantity}`,
    target: "cart",
  });
}
```

## 📊 验证检查清单

- [ ] Function 已成功部署到 Shopify
- [ ] Function 在 Admin 中已激活
- [ ] 能在购物车页面看到调试信息
- [ ] 规则1（数量限制）正常工作
- [ ] 规则2（产品互斥）正常工作
- [ ] 规则3（不能单独购买）正常工作
- [ ] 正常场景可以进入结账
- [ ] 生产部署前已删除调试代码
